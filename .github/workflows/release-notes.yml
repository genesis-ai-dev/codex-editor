name: Generate and Send Release Notes

on:
    # Only handle GitHub's create event (branch/tag) and manual dispatch
    create:

    # Allow manual run for testing
    workflow_dispatch:
        inputs:
            version:
                description: "Version to generate notes for (defaults to created tag)"
                required: false
                type: string

permissions:
    contents: write
    pull-requests: read

jobs:
    release-notes:
        # Run only when a tag is created (or manual dispatch)
        if: ${{ github.event_name == 'create' && github.ref_type == 'tag' || github.event_name == 'workflow_dispatch' }}
        runs-on: ubuntu-latest
        steps:
            - name: Prepare repository (without external actions)
              id: prep
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              shell: bash
              run: |
                  set -euo pipefail
                  REPO="${GITHUB_REPOSITORY}"
                  mkdir -p repo
                  cd repo
                  git init -q
                  git remote add origin "https://x-access-token:${GH_TOKEN}@github.com/${REPO}.git"
                  git fetch -q --tags --prune origin
                  # Ensure the commit for this workflow run is available
                  git fetch -q origin "${GITHUB_SHA}"
                  git checkout -q "${GITHUB_SHA}"

            - name: Determine version and previous tag
              id: version
              shell: bash
              working-directory: repo
              run: |
                  set -euo pipefail
                  if [ -n "${{ github.event.inputs.version || '' }}" ]; then
                    VERSION="${{ github.event.inputs.version }}"
                  else
                    VERSION="${GITHUB_REF#refs/tags/}"
                  fi

                  # Ensure numeric-only tags (no 'v' prefix)
                  if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                    echo "Tag '$VERSION' is not numeric SemVer; skipping." >&2
                    echo "skip=true" >> "$GITHUB_OUTPUT"
                    exit 0
                  fi

                  # Find previous numeric tag for comparison
                  PREV_TAG=$(git tag --sort=-version:refname | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | sed -n '2p' || true)
                  if [ -z "$PREV_TAG" ]; then
                    PREV_TAG=$(git rev-list --max-parents=0 HEAD)
                  fi

                  echo "version=$VERSION" >> "$GITHUB_OUTPUT"
                  echo "previous=$PREV_TAG" >> "$GITHUB_OUTPUT"
                  # Resolve the commit pointed to by the version tag
                  if git rev-parse "$VERSION" >/dev/null 2>&1; then
                    CURR_COMMIT=$(git rev-list -n 1 "$VERSION")
                  else
                    CURR_COMMIT="$GITHUB_SHA"
                  fi
                  echo "current_commit=$CURR_COMMIT" >> "$GITHUB_OUTPUT"

            - name: Stop if non-numeric tag
              if: steps.version.outputs.skip == 'true'
              run: echo "Non-numeric tag detected; workflow skipped."

            - name: Generate Release Notes with GitHub AI
              id: notes
              if: steps.version.outputs.skip != 'true'
              shell: bash
              working-directory: repo
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  set -euo pipefail
                  VERSION="${{ steps.version.outputs.version }}"
                  PREV_TAG="${{ steps.version.outputs.previous }}"

                  echo "Generating notes for v${VERSION} (previous tag: ${PREV_TAG})"

                  # Call GitHub's AI release notes API
                  API_PAYLOAD=$(jq -n --arg tag "$VERSION" --arg prev_tag "$PREV_TAG" \
                    '{tag_name: $tag, previous_tag_name: $prev_tag}')

                  # The API response contains the full release notes body
                  RESPONSE_JSON=$(curl -sS -X POST \
                    -H "Authorization: Bearer ${GH_TOKEN}" \
                    -H "Accept: application/vnd.github+json" \
                    -d "$API_PAYLOAD" \
                    "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/generate-notes")

                  # Extract the body and save it to a file for subsequent steps
                  NOTES_BODY=$(echo "$RESPONSE_JSON" | jq -r '.body')
                  if [ -z "$NOTES_BODY" ] || [ "$NOTES_BODY" = "null" ]; then
                    echo "Error: GitHub API did not return release notes body." >&2
                    echo "API Response: $RESPONSE_JSON"
                    exit 1
                  fi

                  printf '%s' "$NOTES_BODY" > NOTES.md
                  echo "Successfully generated notes from GitHub AI."

            - name: Send to n8n webhook (Discord)
              if: steps.version.outputs.skip != 'true'
              env:
                  N8N_WEBHOOK_URL: ${{ secrets.N8N_WEBHOOK_URL }}
              shell: bash
              working-directory: repo
              run: |
                  set -euo pipefail
                  if [ -z "${N8N_WEBHOOK_URL:-}" ]; then
                    echo "N8N_WEBHOOK_URL is not set; cannot send release notes." >&2
                    exit 1
                  fi

                  VERSION="${{ steps.version.outputs.version }}"
                  
                  # Ensure proper JSON escaping by using jq to read the file
                  PAYLOAD=$(jq -n \
                    --arg version "$VERSION" \
                    --rawfile notes NOTES.md \
                    '{version:$version, notes:$notes}')

                  # The n8n Discord node reads $json.version and $json.notes
                  curl -sS -X POST -H 'Content-Type: application/json' -d "$PAYLOAD" "$N8N_WEBHOOK_URL"
                  echo "Sent release notes for v$VERSION to n8n."

