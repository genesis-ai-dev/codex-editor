name: Generate and Send Release Notes

on:
    # Fire when a tag is pushed
    push:
        tags:
            - "*"

    # Also handle GitHub's create event (branch/tag); we'll guard in steps
    create:

    # Allow manual run for testing
    workflow_dispatch:
        inputs:
            version:
                description: "Version to generate notes for (defaults to created tag)"
                required: false
                type: string

permissions:
    contents: write
    pull-requests: read

jobs:
    release-notes:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Determine version and previous tag
              id: version
              shell: bash
              run: |
                  set -euo pipefail
                  if [ -n "${{ github.event.inputs.version || '' }}" ]; then
                    VERSION="${{ github.event.inputs.version }}"
                  else
                    VERSION="${GITHUB_REF#refs/tags/}"
                  fi

                  # Ensure numeric-only tags (no 'v' prefix)
                  if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                    echo "Tag '$VERSION' is not numeric SemVer; skipping." >&2
                    echo "skip=true" >> "$GITHUB_OUTPUT"
                    exit 0
                  fi

                  # Find previous numeric tag for comparison
                  PREV_TAG=$(git tag --sort=-version:refname | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | sed -n '2p' || true)
                  if [ -z "$PREV_TAG" ]; then
                    PREV_TAG=$(git rev-list --max-parents=0 HEAD)
                  fi

                  echo "version=$VERSION" >> "$GITHUB_OUTPUT"
                  echo "previous=$PREV_TAG" >> "$GITHUB_OUTPUT"

            - name: Stop if non-numeric tag
              if: steps.version.outputs.skip == 'true'
              run: echo "Non-numeric tag detected; workflow skipped."

            - name: Collect commit messages since previous tag
              id: commits
              if: steps.version.outputs.skip != 'true'
              shell: bash
              run: |
                  set -euo pipefail
                  PREV="${{ steps.version.outputs.previous }}"
                  RANGE="$PREV..HEAD"
                  if ! git rev-parse "$PREV" >/dev/null 2>&1; then
                    RANGE="$PREV"
                  fi

                  # Exclude obvious version bump commits
                  COMMITS=$(git log "$RANGE" --no-merges --pretty=format:'• %s' \
                    --grep='bump|version|release' --invert-grep | head -100)

                  if [ -z "$COMMITS" ]; then
                    COMMITS=$(git log "$RANGE" --no-merges --pretty=format:'• %s' | head -100)
                  fi

                  # Provide a fallback if still empty
                  if [ -z "$COMMITS" ]; then
                    COMMITS="• Internal maintenance and dependency updates"
                  fi

                  printf '%s' "$COMMITS" > commits.txt
                  echo "commits<<EOF" >> "$GITHUB_OUTPUT"
                  cat commits.txt >> "$GITHUB_OUTPUT"
                  echo "EOF" >> "$GITHUB_OUTPUT"

            - name: Generate release notes (basic, Copilot-ready)
              id: notes
              if: steps.version.outputs.skip != 'true'
              shell: bash
              run: |
                  set -euo pipefail
                  VERSION="${{ steps.version.outputs.version }}"
                  echo "Creating notes for v$VERSION"

                  {
                    echo "## What's New in v$VERSION"; echo;
                    # Basic grouping prompt for Copilot to refine later if desired
                    echo "$GITHUB_REPOSITORY release notes for v$VERSION" > prompt.txt
                    echo "Group the following commits into Features, Fixes, Improvements:" >> prompt.txt
                    echo >> prompt.txt
                    cat commits.txt >> prompt.txt

                    # Basic list as a fallback body
                    cat commits.txt | sed 's/^• /* /g'
                    echo; echo "### Installation"; echo "Update via VS Code Marketplace or GitHub releases."; echo;
                    echo "### Feedback"; echo "Please report issues on GitHub."
                  } > NOTES.md

                  echo "notes<<EOF" >> "$GITHUB_OUTPUT"
                  cat NOTES.md >> "$GITHUB_OUTPUT"
                  echo "EOF" >> "$GITHUB_OUTPUT"

            - name: Send to n8n webhook (Discord)
              if: steps.version.outputs.skip != 'true'
              env:
                  N8N_WEBHOOK_URL: ${{ secrets.N8N_WEBHOOK_URL }}
              shell: bash
              run: |
                  set -euo pipefail
                  if [ -z "${N8N_WEBHOOK_URL:-}" ]; then
                    echo "N8N_WEBHOOK_URL is not set; cannot send release notes." >&2
                    exit 1
                  fi

                  VERSION="${{ steps.version.outputs.version }}"
                  NOTES_CONTENT=$(cat NOTES.md)
                  PAYLOAD=$(jq -n --arg version "$VERSION" --arg notes "$NOTES_CONTENT" '{version:$version, notes:$notes}')

                  # The n8n Discord node reads $json.version and $json.notes
                  curl -sS -X POST -H 'Content-Type: application/json' -d "$PAYLOAD" "$N8N_WEBHOOK_URL"
                  echo "Sent release notes for v$VERSION to n8n."

            - name: Create draft GitHub release
              if: github.event_name == 'create' && github.ref_type == 'tag' && steps.version.outputs.skip != 'true'
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ steps.version.outputs.version }}
                  name: Release ${{ steps.version.outputs.version }}
                  body: ${{ steps.notes.outputs.notes }}
                  draft: true

